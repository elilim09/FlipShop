<!-- chat.html -->
<!DOCTYPE html>
<html>
<head>
    <title>채팅방</title>
</head>
<body>
    <h1>채팅방</h1>
    <div id="messages">
        <!-- 메시지가 여기에 표시됩니다 -->
    </div>
    <form id="message-form">
        <input type="hidden" id="user_id" value="{{ user_id }}">
        <input type="text" id="message-input" placeholder="메시지를 입력하세요" required>
        <button type="submit">전송</button>
    </form>

    <script>
        const chatId = {{ chat_id }};
        const userId = document.getElementById('user_id').value;
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');

        // 메시지 불러오기
        async function loadMessages() {
            const response = await fetch(`/chat/${chatId}/messages`);
            if (response.ok) {
                const messages = await response.json();
                messagesDiv.innerHTML = '';
                messages.forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.innerHTML = `
                        <p><strong>${msg.sender_id === parseInt(userId) ? '나' : '상대방'}:</strong> ${msg.message}</p>
                        <p>${msg.sent_at}</p>
                    `;
                    messagesDiv.appendChild(msgDiv);
                });
            } else {
                alert('메시지를 불러오지 못했습니다.');
            }
        }

        // 메시지 전송
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = messageInput.value;
            const formData = new FormData();
            formData.append('message', message);

            const response = await fetch(`/chat/${chatId}/messages`, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                messageInput.value = '';
                loadMessages();
            } else {
                alert('메시지를 전송하지 못했습니다.');
            }
        });

        // 일정 간격으로 메시지 업데이트
        setInterval(loadMessages, 3000);

        // 페이지 로드 시 메시지 불러오기
        loadMessages();
    </script>
</body>
</html>